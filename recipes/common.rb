#
# Cookbook Name:: centos_cloud
# Recipe:: common
#
# Copyright Â© 2014 Leonid Laboshin <laboshinl@gmail.com>
# This work is free. You can redistribute it and/or modify it under the
# terms of the Do What The Fuck You Want To Public License, Version 2,
# as published by Sam Hocevar. See http://www.wtfpl.net/ for more details.
#<
#This recipe produces some initial configuration. 
#>

#<> - Call [selinux](#centos_cloudselinux) recipe to disable selinux;
include_recipe "centos_cloud::selinux"
#<> - Call [repos](#centos_cloudrepos) recipe recipe to configure repositories;
include_recipe "centos_cloud::repos"
# Include firewalld lwrp; 
include_recipe "firewalld"
#<> - Call [firewall](#centos_cloudfirewall) recipe to define additional services;
include_recipe "centos_cloud::firewall"
# Include ssh keys lwrp;
include_recipe "libcloud::ssh_key"
#<> - Call [ntp](#centos_cloudfirewall) recipe to setup time synchronisation;
include_recipe "centos_cloud::ntp"

#<> - [x] Install some usefull tools;
%w[bash-completion python-openstackclient].each do |pkg|
  package pkg do
    action :install
  end
end

#<> - [x] Copy private ssh key to `id_rsa` & add public key to `authorized_keys`;
libcloud_ssh_keys "openstack" do
  data_bag "ssh_keypairs"
  action [:create, :add]
end

#<> - [x] <del>Disable NetworkManager</del> 
#service "NetworkManager" do 
#  action [:stop, :disable]
#end

#<> - [x] Disable IPv6;
libcloud_file_append "/etc/sysctl.conf" do
  line [
    "net.ipv6.conf.all.disable_ipv6=1",
    "net.ipv6.conf.default.disable_ipv6=1"]
  notifies :run, "execute[sysctl -p]"
end

execute "sysctl -p" do
  action :nothing
end

#<> - [x] Write openstack credentials to root's `.bashrc`;
libcloud_file_append "/root/.bashrc" do
  line [
    "# Keystone credentials generated by chef",
    "export OS_USERNAME=admin",
    "export OS_TENANT_NAME=admin",
    "export OS_PASSWORD=#{node[:creds][:admin_password]}",
    "export OS_AUTH_URL=http://#{node[:ip_ex][:keystone]}:5000/v2.0/"]
end

